@(fuzzySystem : FuzzySystem, spec: xfuzzy.lang.Specification)

<script type="text/javascript">


	Raphael.fn.arrow = function (x1, y1, x2, y2, size) {
		var angle = Math.atan2(x1-x2,y2-y1);
		angle = (angle / (2 * Math.PI)) * 360;
		var arrowPath = this.path("M" + x2 + " " + y2 + " L" + (x2  - size) + " " + (y2  - size) + " L" + (x2  - size)  + " " + (y2  + size) + " L" + x2 + " " + y2 ).attr("fill","black").rotate((90+angle),x2,y2);
		var linePath = this.path("M" + x1 + " " + y1 + " L" + x2 + " " + y2);
		return [linePath,arrowPath];
	};


	Raphael.fn.arrow_elem = function(base, origin, destiny, size) {
		console.log("origin");
		console.log(origin);
		console.log("destiny");
		console.log(destiny);
		
		var x0 = origin.offset().left - base.offset().left;// + 4;
		var y0 = origin.offset().top -  base.offset().top;// + 4;
			
		var x1 = destiny.offset().left - base.offset().left;// + 4;
		var y1 = destiny.offset().top - base.offset().top;// + 4;
		console.log("x0:" + x0 + " y0:" + y0 +" x1:" + x1 +" y1:" + y1);
		return this.arrow(x0,y0,x1,y1,size); 
	};


	//instantiate the global link
	var current_link = {};
    current_link.variableDots = new Array();   

	var paper;
	
	
	$(document).ready(function() {

		
        $( ".rulebasecall" ).draggable({ 
        				containment: "#system_design",
        				scroll: false ,
        				cursor: "move",
        				cursorAt: { top: 56, left: 56 },
        				//revert: true, 
//        				snap: ".rulebasecall"
					});
        
        /* return an dict with the datas parsed from the id of the given link */
        function parseIDforDot(dot){
        	var id = dot.attr("id");
        	var allInfo = id.split("__");

        	var idRuleBaseCall = allInfo[1].split("-")[1];
        	if(idRuleBaseCall == "n"){
        		idRuleBaseCall="";
        	}
        	
        	var idSysVar = allInfo[2].split("-")[1];
        	var kindSysVar = allInfo[2].split("-")[2];
        	if(idSysVar == "n"){
        		idSysVar="";
        		kindSysVar="";
        	}
        	
        	var idBaseVar = allInfo[3].split("-")[1];
        	var kindBaseVar = allInfo[3].split("-")[2];
        	if(idBaseVar == "n"){
        		idBaseVar="";
        		kindBaseVar="";
        	}
        	
        	var infos = {};
        	infos.idRuleBaseCall = idRuleBaseCall;
        	
        	infos.idSysVar = idSysVar;
        	infos.kindSysVar = kindSysVar;
        	
        	infos.idBaseVar = idBaseVar;
        	infos.kindBaseVar = kindBaseVar;
        	return infos;
        }
        
        /* return a variabledot element for a given variableDot object */
        function getLinkElementForVariableDot(variableDot){
        	var element_id = "dot__rulebaseCall-RBC-__sysVar-SVI-SVK-__baseVar-BVI-BVK-"
				console.log("getLinkElementForVariableDot");
				console.log(variableDot);
        		element_id = element_id.replace(/RBC/g, variableDot.idRuleBaseCall);
				element_id = element_id.replace(/SVI/g, variableDot.idSysVar);
				element_id = element_id.replace(/SVK/g, variableDot.kindSysVar);
				element_id = element_id.replace(/BVI/g, variableDot.idBaseVar);
				element_id = element_id.replace(/BVK/g, variableDot.kindBaseVar);
				console.log("element_id");
				console.log(element_id);
				return $("#"+element_id);
        }

       	
        /** adds the logic for the click of each link dot **/
        $("[id^='dot__']").each(function() {
            console.log("changed dot");
            var jqThis = $(this);
            
            jqThis.data("dot_info",parseIDforDot(jqThis));
            console.log("dot_info:");
            console.log(jqThis.data("dot_info"));
            jqThis.click(function(evt){
            	jqThis.attr("class","link_dot_marked");

            	if(current_link.variableDots.length  == 2){
                	current_link.variableDots = new Array();
            	}
            	
            	current_link.variableDots.push(jqThis.data("dot_info"));
            	if(current_link.variableDots.length  > 1){
                	post_link();
            	}            	
            	console.log("current_link");
            	console.log(current_link);
            	console.log(jqThis.attr("id"));
            });
        });
        
        function post_link(){
        	//current_link;
        	console.log(JSON.stringify(current_link));
        	var new_link = current_link;
        	$.post('@routes.RuleBaseCalls.ajaxAddLink(fuzzySystem.id)',
       			{
					'variableDots[0].idRuleBaseCall': current_link.variableDots[0].idRuleBaseCall,
					'variableDots[0].idSysVar': current_link.variableDots[0].idSysVar,
					'variableDots[0].kindSysVar': current_link.variableDots[0].kindSysVar,
					'variableDots[0].idBaseVar': current_link.variableDots[0].idBaseVar,
					'variableDots[0].kindBaseVar': current_link.variableDots[0].kindBaseVar,
					
					'variableDots[1].idRuleBaseCall': current_link.variableDots[1].idRuleBaseCall,
					'variableDots[1].idSysVar': current_link.variableDots[1].idSysVar,
					'variableDots[1].kindSysVar': current_link.variableDots[1].kindSysVar,
					'variableDots[1].idBaseVar': current_link.variableDots[1].idBaseVar,
					'variableDots[1].kindBaseVar': current_link.variableDots[1].kindBaseVar,
       			},
                function(data) {
    				console.log(data);
					var elem_dot0 = getLinkElementForVariableDot(new_link.variableDots[0]);
					var elem_dot1 = getLinkElementForVariableDot(new_link.variableDots[1]);

					var system_design = $("#system_design");
                    console.log("elem_dot0");
                    console.log(elem_dot0);
                    console.log("elem_dot1");
                    console.log(elem_dot1);
                    console.log("system_design");
                    console.log(system_design);
					var arrow = paper.arrow_elem(system_design, elem_dot0, elem_dot1, 8);    
           	});
        	
        	reset_current_link();
        	
        }
        
        function reset_current_link(){
        	$(".link_dot_marked").attr("class","link_dot");
        }
        
        
/**

			$("#bottomMost").draggable({
				drag: function(event,ui) {
						paper.clear();
						var middleX = ui.position.left + (ui.helper.width())/2 - 8;
						var middleY = ui.position.top + (ui.helper.height())/2 -34;
						var arrow = paper.arrow(45,68,middleX,middleY,8);
				},

				snap: ".rulebasecall"
			});
*/
		
			// Create initial Raphael canvas
			paper = new Raphael("system_design",770,390);

			//var arrow = paper.arrow(28.5,138,290.5,135,8);    				
	});   

</script>