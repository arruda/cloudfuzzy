@(fuzzySystem : FuzzySystem, spec: xfuzzy.lang.Specification)

<script type="text/javascript">

	//instantiate the global link
	var current_link = {};
    current_link.variableDots = new Array();   
	
    /* The global variable for the canvas */
	var paper;

    /* return an dict with the datas parsed from the id of the given link */
    function parseIDforDot(dot){
    	var id = dot.attr("id");
    	var allInfo = id.split("__");

    	var idRuleBaseCall = allInfo[1].split("-")[1];
    	if(idRuleBaseCall == "n"){
    		idRuleBaseCall="";
    	}
    	
    	var idSysVar = allInfo[2].split("-")[1];
    	var kindSysVar = allInfo[2].split("-")[2];
    	if(idSysVar == "n"){
    		idSysVar="";
    		kindSysVar="";
    	}
    	
    	var idBaseVar = allInfo[3].split("-")[1];
    	var kindBaseVar = allInfo[3].split("-")[2];
    	if(idBaseVar == "n"){
    		idBaseVar="";
    		kindBaseVar="";
    	}
    	
    	var infos = {};
    	infos.idRuleBaseCall = idRuleBaseCall;
    	
    	infos.idSysVar = idSysVar;
    	infos.kindSysVar = kindSysVar;
    	
    	infos.idBaseVar = idBaseVar;
    	infos.kindBaseVar = kindBaseVar;
    	return infos;
    }
    
    
    function getVaraibleDotIDForVariableDot(variableDot){
    	var element_id = "dot__rulebaseCall-RBC-__sysVar-SVI-SVK-__baseVar-BVI-BVK-"
			console.log("getVariableDotElementForVariableDot");
			console.log(variableDot);
    		element_id = element_id.replace(/RBC/g, variableDot.idRuleBaseCall);
			element_id = element_id.replace(/SVI/g, variableDot.idSysVar);
			element_id = element_id.replace(/SVK/g, variableDot.kindSysVar);
			element_id = element_id.replace(/BVI/g, variableDot.idBaseVar);
			element_id = element_id.replace(/BVK/g, variableDot.kindBaseVar);
			return element_id;
    }
    
    /* return a variabledot element for a given variableDot object */
    function getVariableDotElementForVariableDot(variableDot){
			return $("#"+getVaraibleDotIDForVariableDot(variableDot));
    }
    


   	/* creates a link */
    function post_link(){
    	//current_link;
    	console.log(JSON.stringify(current_link));
    	var new_link = current_link;
    	$.post('@routes.RuleBaseCalls.ajaxAddLink(fuzzySystem.id)',
   			{
				'variableDots[0].idRuleBaseCall': current_link.variableDots[0].idRuleBaseCall,
				'variableDots[0].idSysVar': current_link.variableDots[0].idSysVar,
				'variableDots[0].kindSysVar': current_link.variableDots[0].kindSysVar,
				'variableDots[0].idBaseVar': current_link.variableDots[0].idBaseVar,
				'variableDots[0].kindBaseVar': current_link.variableDots[0].kindBaseVar,
				
				'variableDots[1].idRuleBaseCall': current_link.variableDots[1].idRuleBaseCall,
				'variableDots[1].idSysVar': current_link.variableDots[1].idSysVar,
				'variableDots[1].kindSysVar': current_link.variableDots[1].kindSysVar,
				'variableDots[1].idBaseVar': current_link.variableDots[1].idBaseVar,
				'variableDots[1].kindBaseVar': current_link.variableDots[1].kindBaseVar,
   			},
            function(data) {
				console.log(data);
				var elem_dot0 = getVariableDotElementForVariableDot(new_link.variableDots[0]);
				var elem_dot1 = getVariableDotElementForVariableDot(new_link.variableDots[1]);

				var system_design = $("#system_design");
                console.log("elem_dot0");
                console.log(elem_dot0);
                console.log("elem_dot1");
                console.log(elem_dot1);
                console.log("system_design");
                console.log(system_design);
                createOrUpdateLink(paper,new_link,null);
				//var arrow = paper.arrow_elem(system_design, elem_dot0, elem_dot1, 8,null);    
       	});
    	
    	reset_current_link();
    	
    }
    
    function reset_current_link(){
    	$(".link_dot_marked").attr("class","link_dot");
    }
    

    /* create a link(object) from a dict of informations */
    function createLinkObjFromOptions(linkInfo){
		var link = {}
		link.variableDots = new Array();

		link.variableDots.push({
				"idRuleBaseCall" : linkInfo["variableDots[0].idRuleBaseCall"],
				"idBaseVar" : linkInfo["variableDots[0].idBaseVar"],
				"kindBaseVar" : linkInfo["variableDots[0].kindBaseVar"],
				"idSysVar" : linkInfo["variableDots[0].idSysVar"],
				"kindSysVar" : linkInfo["variableDots[0].kindSysVar"]
				});
		link.variableDots.push({
			"idRuleBaseCall" : linkInfo["variableDots[1].idRuleBaseCall"],
			"idBaseVar" : linkInfo["variableDots[1].idBaseVar"],
			"kindBaseVar" : linkInfo["variableDots[1].kindBaseVar"],
			"idSysVar" : linkInfo["variableDots[1].idSysVar"],
			"kindSysVar" : linkInfo["variableDots[1].kindSysVar"]
			});
		
		
		return link;
    }
    
    /* add a given link object to the canvas */
    function createOrUpdateLink(a_canvas, new_link_obj,id_link){

    	var system_design = $("#system_design");
    	
		var elem_dot0 = getVariableDotElementForVariableDot(new_link_obj.variableDots[0]);
		var elem_dot1 = getVariableDotElementForVariableDot(new_link_obj.variableDots[1]);
    	
		
		var link = a_canvas.arrow_elem(system_design, elem_dot0, elem_dot1, 8,id_link);  

		link.data("link",new_link_obj);
		
		console.log("adding rbc links");

		console.log("new_link_obj.variableDots[0].idRuleBaseCall");
		console.log(new_link_obj.variableDots[0].idRuleBaseCall);
		console.log("new_link_obj.variableDots[1].idRuleBaseCall");
		console.log(new_link_obj.variableDots[1].idRuleBaseCall);
		//tryes to link with the origin and the destin 
		if(new_link_obj.variableDots[0].idRuleBaseCall != ""){
			addLinkToRulebaseCall(getRulebaseCallElem(new_link_obj.variableDots[0].idRuleBaseCall),link);
		}
		if(new_link_obj.variableDots[1].idRuleBaseCall != ""){
			addLinkToRulebaseCall(getRulebaseCallElem(new_link_obj.variableDots[1].idRuleBaseCall),link);
		}
    	return link;			
    }
    

    /* return a given rulebasecall element passing the given id */
    function getRulebaseCallElem(rulebasecall_id){
    	return $("#rulebasecall_"+rulebasecall_id);
    }
    
	
	
	/* add a link to a rulebasecall element */
	function addLinkToRulebaseCall(rbc_elem, link){
		var rule_links = rbc_elem.data("links");
		//if it wasn't defined yet, then define it 
		if(rule_links == undefined){
			rule_links = new Array();
		}
		
		//don't add the same again 
		for(var k = 0; k < rule_links.length; k++){
			if(rule_links[k] == link.id){
				return;
			}
		}
		
		rule_links.push(link.id);
		rbc_elem.data("links",rule_links);
		
	}
	
	/* return a links of links (raphaels) of this rulebasecall */
	function getRulebaseCallLinks(rbc_elem){
		var my_links = [];
		var links_ids = rbc_elem.data("links");
		for(var k = 0; k < links_ids.length; k++){
			my_links.push(paper.getById(links_ids[k]));
		}
		return my_links;
	}
    
	$(document).ready(function() {

	    
        $( ".rulebasecall" ).draggable({ 
        				containment: "#system_design",
        				scroll: false ,
        				cursor: "move",
        				cursorAt: { top: 56, left: 56 },
        				drag: function(event,ui) {
        					var jqthis = $(this);
        					var updated_links = getRulebaseCallLinks(jqthis);
        					$.each(updated_links, function(index,link){        						
        						createOrUpdateLink(paper,link.data("link"),link.id);	
        					});
    					},
        				//revert: true, 
//        				snap: ".rulebasecall"
					});
        
       	
        /** adds the logic for the click of each link dot **/
        $("[id^='dot__']").each(function() {
            console.log("changed dot");
            var jqThis = $(this);
            
            jqThis.data("dot_info",parseIDforDot(jqThis));
            console.log("dot_info:");
            console.log(jqThis.data("dot_info"));
            jqThis.click(function(evt){
            	jqThis.attr("class","link_dot_marked");

            	if(current_link.variableDots.length  == 2){
                	current_link.variableDots = new Array();
            	}
            	
            	current_link.variableDots.push(jqThis.data("dot_info"));
            	if(current_link.variableDots.length  > 1){
                	post_link();
            	}            	
            	console.log("current_link");
            	console.log(current_link);
            	console.log(jqThis.attr("id"));
            });
        });
        

        /** adds some aditional information on each rulebasecall **/
        /*
        $(".rulebasecall").each(function() {
            console.log("changed rulebasecall");
            var jqThis = $(this);
            
            jqThis.data("links",new Array());
            console.log("links:");
            console.log(jqThis.data("links"));
        });
        */
/**

			$("#bottomMost").draggable({
				drag: function(event,ui) {
						paper.clear();
						var middleX = ui.position.left + (ui.helper.width())/2 - 8;
						var middleY = ui.position.top + (ui.helper.height())/2 -34;
						var arrow = paper.arrow(45,68,middleX,middleY,8);
				},

				snap: ".rulebasecall"
			});
*/
		
			// Create initial Raphael canvas
			paper = new Raphael("system_design",770,390);


		


			function addLinksToRulebaseCalls(){

		    	var linkInfo = {};
		    	var link_obj;
		    	var link;
				//adding each one of the links 
			    @for( link <- models.LinkCallForm.getLinks(fuzzySystem)){
			    	linkInfo = {};
			    	linkInfo["variableDots[0].idRuleBaseCall"] = "@link.variableDots(0).idRuleBaseCall";
			    	linkInfo["variableDots[0].idSysVar"] = "@link.variableDots(0).idSysVar";
			    	linkInfo["variableDots[0].kindSysVar"] = "@link.variableDots(0).kindSysVar";
			    	linkInfo["variableDots[0].idBaseVar"] = "@link.variableDots(0).idBaseVar";
			    	linkInfo["variableDots[0].kindBaseVar"] = "@link.variableDots(0).kindBaseVar";
			    	
			    	linkInfo["variableDots[1].idRuleBaseCall"] = "@link.variableDots(1).idRuleBaseCall";
			    	linkInfo["variableDots[1].idSysVar"] = "@link.variableDots(1).idSysVar";
			    	linkInfo["variableDots[1].kindSysVar"] = "@link.variableDots(1).kindSysVar";
			    	linkInfo["variableDots[1].idBaseVar"] = "@link.variableDots(1).idBaseVar";
			    	linkInfo["variableDots[1].kindBaseVar"] = "@link.variableDots(1).kindBaseVar";
					link_obj= createLinkObjFromOptions(linkInfo);
					link = createOrUpdateLink(paper,link_obj,null);		
					
			    }
			}
			
			addLinksToRulebaseCalls();
		    		
	});   

</script>