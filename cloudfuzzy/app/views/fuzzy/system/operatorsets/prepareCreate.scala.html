@(systemId: Long, newOPSetForm: Form[models.OperatorSet])

@import helper._


@hiddenField(field: Field, className: String = "") = {
    @input(field, '_label -> null , '_class -> null ) { (id, name, value, _) =>
        <input type="hidden" name="@name" value="@value" class="@className"> 
    }
}

@operatorField(field: Field) = {


    @hiddenField(field("name"))

    @select(
        field("selectedOption"),
        options =  options(
                        models.OperatorSet.getAvailableOptionsMapForOperatorsByOperatorLabel(
                            field("name").value.getOrElse("")
                        )
                    ),
        '_label -> field("name").value,
        '_class -> "option_field"
    )          

    

}
@*** 
@main("Fuzzy System")(fuzzy.system.operatorsets.menu_add(systemId)){ 
***@
@main("")(menu_default()){    
    <div class="sub_content sub_limited">
        <h3 class='sub_content_header'>New Fuzzy Operator Set</h3> 
            @helper.form(action = routes.OperatorSets.create(systemId), 'id -> "newOPSetForm") {
                
                <fieldset>
                    <legend>General Information for the new Operator Set</legend>
                    
                    @inputText(
                        newOPSetForm("name"), 
                        '_label -> "Name", 
                        '_help -> "The name of this Operator Set."
                    )                

                    
                </fieldset>           
                
                <fieldset>
                    <legend>Select Operators</legend>

                    @repeat(newOPSetForm("operators")) { operator =>
                        
                        @operatorField(operator)

                        @repeat(operator("params")) { params =>
                            
                            @hiddenField(params("name"), "parameter")
                            @hiddenField(params("value"), "parameter")
                            
                        }   
                        
                    }   

                </fieldset>         
                
                <div class="actions">
                    <input type="submit" class="btn primary" value="Create">
                </div>
                
            }
 
    </div>
    <div id="dialog-modal" title="Parameters Information">
        <p>This option requires the definition of some parameters, please expecify them.</p>
        <form id="params-dl-form">
        </form>
    </div>

    <script type="text/javascript">

        $(document).ready(function() {

            $( "#dialog-modal" ).dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    Ok: function() {
                        var dl_form = $( this ).find("#params-dl-form");

                        var option = $( this ).data("option");
                        var id_opType = $( this ).data("id_opType");
                        var id_option = $( this ).data("id_option");

                        var newParams = [];

                        dl_form.find("label").each(function(){
                            var newParam = {};
                            var name = $( this ).html();
                            var val = $("#" + $( this ).attr("for")).val();
                            newParam.name =name;
                            newParam.value = val;
                            newParams.push(newParam);
                        });

                        setParamsHtmls(option, id_opType, id_option, newParams);
                        option.data("prev", option.val());
                        $( this ).dialog( "close" );
                        dl_form.contents("input").remove();
                        dl_form.contents("label").remove();
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                        var dl_form = $( this ).find("#params-dl-form");
                        var option = $($( this ).data("option"));
                        option.val("" + option.data("prev"));
                        //option.find("option:selected").attr("selected",false);
                        //option.find("[value='"+ option.val() +"']").attr("selected",true);
                        //console.log(option);

                        dl_form.contents("input").remove();
                        dl_form.contents("label").remove();
                    }
                },
                close: function() {                   
                    $( this ).dialog( "close" );
                    var dl_form = $( this ).find("#params-dl-form");
                    var option =  $($( this ).data("option"));
                    //var option = $("#operators_2__selectedOption");
                    // option.find("option:selected").attr("selected",false);
                    // option.find("[value='"+ option.val() +"']").attr("selected",true);
                    option.val(option.data("prev"));
                    // console.log(option);
                    // console.log(option.val());
                    // console.log(option.data("prev"));

                    dl_form.contents("input").remove();
                    dl_form.contents("label").remove();
                }
            });

            //get parameters for a given operator selected option
            function getParamsForOption(option) { 
                //$("#operators_0__selectedOption")
                var id_option = option.val();
                var id_opType = option.attr('id').split("operators_")[1].split("__selectedOption")[0];

                console.log("getParamsForOption(" + id_opType + "," + id_option + ")");
                //get the parameters for the operator
                $.get('/ajax/get_num_params_operator_option',
                      {
                        id_option: id_option,
                        id_opType: id_opType
                      },
                      function(data) {
                        var newParams = data;
                        //if has params then open dialog, else will probably just remove any that was there before
                        if(newParams.length == 0){
                            setParamsHtmls(option, id_opType, id_option, newParams);                           
                            console.log(option.data("prev")); 
                            console.log("setting new val:"+ id_option);
                            option.data("prev", option.val());                          
                            console.log(option.data("prev"));
                        }
                        else{
                            openDialogForParams(option, id_opType, id_option, newParams);
                        }
                        
                });
            }

            $("[id$='selectedOption']").each(function() {
                var jqThis = $(this);
                jqThis.data("prev",jqThis.val())
                jqThis.change(function(){
                    console.log("prev:"+ jqThis.data("prev"))
                    getParamsForOption(jqThis);
                    // jqThis.data("prev new:",jqThis.val())

                });
                //getParamsForOption($(this));
            });

            /* Creates the html for the new param hidden inputs */
            function getNewParamHtml(newParamInfo, name, value){
                var paramNameHTML ='<input type="hidden" name="NAME" value="VAL" class="parameter">';

                paramNameHTML = paramNameHTML.replace(/NAME/g, newParamInfo+'.name');
                paramNameHTML = paramNameHTML.replace(/VAL/g, name);

                var paramValueHTML ='<input type="hidden" name="NAME" value="VAL" class="parameter">';

                paramValueHTML = paramValueHTML.replace(/NAME/g, newParamInfo+'.value');
                paramValueHTML = paramValueHTML.replace(/VAL/g, value);


                return paramNameHTML + paramValueHTML;
            }

            /* Adds the html for the inputs of each new param in the form, and remove the old ones if any */
            function setParamsHtmls(option, id_opType, id_option, newParams){

                console.log("setParamsHtmls: " + option.attr('id') + ", " + id_opType + ", "+id_option + ", " + newParams); 
                console.log("newParams: "); 
                console.log(newParams); 

                var form = $("#newOPSetForm");
                // operators[0].options[1].name

                //see if should add the i or the newParams[i]
                var oldParams = $("[name^='operators["+ id_opType +"].params']");

                //remove if any
                oldParams.each(function(){
                    console.log("removing: "+ $(this).attr('name'));
                    $(this).remove();
                });
                for (var i = 0; i < newParams.length; i++) {

                    //add new params inputs
                    var newParamInfo = "operators[" + id_opType + "].params[" + i +"]";
                    var newParamHtml = getNewParamHtml(newParamInfo, newParams[i].name, newParams[i].value);
                    form.append(newParamHtml);
                    console.log("adding: "+newParamHtml + "\n" +"to: " + form.attr('id'));
                };
            }

            /* Open the dialog to input the data of the new params */
            function openDialogForParams(option, id_opType, id_option, newParams){
                var dialog = $( "#dialog-modal" );


                var dl_form = dialog.find("#params-dl-form");

                for (var i = 0; i < newParams.length; i++) {
                    var param_label= "<label for='param_"+ i +"_value'>"+ newParams[i].name +"</label>";
                    var param_input= "<input type='text' id='param_"+ i +"_value' name='param[" + i + "].value' value='" + newParams[i].value + "' >";                            
                    dl_form.append(param_label+param_input);
                    console.log("adding: "+param_label+param_input + "\n" +"to: " + dl_form.attr('id'));
                };
                                

                dialog.data("option", option);
                dialog.data("id_opType", id_opType);
                dialog.data("id_option", id_option);
                dialog.data("newParams", newParams);
                dialog.dialog( "open" );

            }


        });
                
    </script>
    
}