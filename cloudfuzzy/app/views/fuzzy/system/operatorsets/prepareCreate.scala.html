@(systemId: Long, newOPSetForm: Form[models.OperatorSet])

@import helper._


@hiddenField(field: Field, className: String = "") = {
    @input(field, '_label -> null , '_class -> null ) { (id, name, value, _) =>
        <input type="hidden" name="@name" value="@value" class="@className"> 
    }
}

@operatorField(field: Field) = {


    @hiddenField(field("name"))

    @select(
        field("selectedOption"),
        options =  options(
                        models.OperatorSet.getAvailableOptionsMapForOperatorsByOperatorLabel(
                            field("name").value.getOrElse("")
                        )
                    ),
        '_label -> field("name").value,
        '_class -> "option_field"
    )          

    

}
@*** 
@main("Fuzzy System")(fuzzy.system.operatorsets.menu_add(systemId)){ 
***@
@fuzzy.system.system_template{    
    <div class="sub_content sub_limited">
        <h3 class='sub_content_header'>New Fuzzy Operator Set</h3> 
            @helper.form(action = routes.OperatorSets.create(systemId), 'id -> "newOPSetForm") {
                
                <fieldset>
                    <legend>General Information for the new Operator Set</legend>
                    
                    @inputText(
                        newOPSetForm("name"), 
                        '_label -> "Name", 
                        '_help -> "The name of this Operator Set."
                    )                

                    
                </fieldset>           
                
                <fieldset>
                    <legend>Select Operators</legend>

                    @repeat(newOPSetForm("operators")) { operator =>
                        
                        @operatorField(operator)

                        @repeat(operator("options")) { option =>
                            
                            @hiddenField(option("name"), "parameter")
                            @hiddenField(option("value"), "parameter")
                            
                        }   
                        
                    }   


                    @****

                    @operatorField(
                        newOPSetForm("operators[0]")
                    )

	                @repeat(contactForm("informations")) { information =>
	                
	                    @informationGroup(information)
	                
	                }
	                ****@
                </fieldset>         
                
                <div class="actions">
                    <input type="submit" class="btn primary" value="Create">
                </div>
                
            }
 
    </div>
    <div id="dialog-modal" title="Parameters Information">
        <form id="params-dl-form">

        </form>
    </div>

    <script type="text/javascript">

        $(document).ready(function() {

            $( "#dialog-modal" ).dialog({
                height: 300,
                width: 350,
                autoOpen: false,
                height: 140,
                modal: true
            });

            //get parameters for a given operator selected option
            function getParamsForOption(option) { 
                //$("#operators_0__selectedOption")
                var id_option = option.val();
                var id_opType = option.attr('id').split("operators_")[1].split("__selectedOption")[0];

                console.log("getParamsForOption(" + id_opType + "," + id_option + ")");
                //get the parameters for the operator
                $.get('/ajax/get_num_params_operator_option',
                      {
                        id_option: id_option,
                        id_opType: id_opType
                      },
                      function(data) {
                        var newParams = data;
                        setParamsHtmls(option, id_opType, id_option, newParams);
                        // $( "#dialog-modal" ).dialog( "open" );
                        
                });
            }

            $("[id$='selectedOption']").each(function() {
                $(this).change(function(){
                    getParamsForOption($(this));

                });
                //getParamsForOption($(this));
            });

            /* Creates the html for the new param hidden input */
            function getNewParamHtml(newParamInfo, name, value){
                var paramNameHTML ='<input type="hidden" name="NAME" value="VAL" class="parameter">';

                paramNameHTML = paramNameHTML.replace(/NAME/g, newParamInfo+'.name');
                paramNameHTML = paramNameHTML.replace(/VAL/g, name);

                var paramValueHTML ='<input type="hidden" name="NAME" value="VAL" class="parameter">';

                paramValueHTML = paramValueHTML.replace(/NAME/g, newParamInfo+'.value');
                paramValueHTML = paramValueHTML.replace(/VAL/g, value);


                return paramNameHTML + paramValueHTML;
            }

            function setParamsHtmls(option, id_opType, id_option, newParams){
                var form = $("#newOPSetForm");
                // operators[0].options[1].name
                var oldParams = $("[name^='operators["+ id_opType +"].options["+ id_option +"].']");

                //remove if any
                oldParams.each(function(){
                    $(this).remove();
                });
                for (var i = 0; i < newParams.length; i++) {
                    //see if should add the i or the newParams[i]
                    var newParamInfo = "operators[" + id_opType + "].options[" + i +"]";
                    var newParamHtml = getNewParamHtml(newParamInfo, newParams[i].name, newParams[i].value);
                    form.append(newParamHtml);
                    console.log("adding: "+newParamHtml + "\n" +"to: " + form.attr('id'));
                };
            }


        });
                
    </script>
    
}