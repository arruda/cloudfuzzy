@(fuzzySystem : FuzzySystem, rb : models.RuleBase)

@import helper._

  
@navHeader = {
    @fuzzySystem.name + " -> " + @rb.name
}  

@fuzzy.system.rulebases.rulebase_template(fuzzySystem, rb){   

    <div class="sub_content sub_limited">
        <h3 class='sub_content_header'>General Information</h3>

        <p>Name: @rb.name</p>

        <p>Operator Set: @FuzzySystem.getAvailableOperatorSetForFuzzySystem(fuzzySystem)(rb.idOperatorSet)</p>
        
    </div>
    <div class="sub_content sub_limited">
        <h3 class='sub_content_header'>Input Variables</h3>         
        <div id="input_vars">    	
        	@if(rb.inputvars != null){
	            <ul>
	            @for( i <- 0 to rb.inputvars.length-1 ) {
	                <li>	
                        @rb.inputvars(i).name
	                </li>
	             }
	            </ul>
        	}
        </div>  
        <input id="new_ivar" type="button" class="btn secondary" value="Add New Variable" />

    </div>
    <div class="sub_content sub_limited">
        <h3 class='sub_content_header'>Output Variables</h3>
        <div id="output_vars">
            @if(rb.outputvars != null){
                <ul>
                @for( i <- 0 to rb.outputvars.length-1 ) {
                    <li>    
                        @rb.outputvars(i).name
                    </li>
                 }
                </ul>
            }
        </div>  
        <input id="new_ovar" type="button" class="btn secondary" value="Add New Variable" />

    </div>
    <div id="dialog-modal" title="New Variable">
        <form id="variable-dl-form">
        	<ul style="list-style:none;">
    			<li>
		        	<label for="name">Name</label>
		        	<input type="text" id="var_name" name="name" value="" >
				</li>
    			<li>
		        	<label for="idType">Type</label></br>
					<select id="var_idType" name="idType" >

			            @for( i <- 0 to fuzzySystem.getSpecification().getTypes().length-1 ) {
						
								<option value="@i" >
									@fuzzySystem.getSpecification().getTypes()(i).getName()
								</option>
		                        
			             }
					</select>
				</li>
                <li>
                    <input type="hidden" id="var_kind" name="kind" value="" > 
                </li>
    		</ul>
        </form>
    </div>

    <script type="text/javascript">

        $(document).ready(function() {

        	var num_ivars = 0;
        	@if(rb.inputvars != null){
	            num_ivars = @rb.inputvars.length;
        	}
        	var num_ovars = 0;
        	@if(rb.outputvars != null){
	            num_ovars = @rb.outputvars.length;
        	}

            $( "#dialog-modal" ).dialog({
                autoOpen: false,
                modal: true,
                buttons: {
                    Ok: function() {
                        var new_var_form = $( this ).find("#variable-dl-form");

                        postNewVar(function(data){
                            console.log(data);



                            //add the new var to the list
                            var var_list = $("#input_vars");
                            if(new_var_form.find("[name='kind']").val() == @Variable.OUTPUT){
                                var var_list = $("#output_vars");
                            }
                            var_list = var_list.find("ul");
                            var_list.append("<li>" + new_var_form.find("[name='name']").val() + "</li>");

                            $( "#dialog-modal" ).dialog( "close" );

                        });

                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                },
                close: function() {                   
                    $( this ).dialog( "close" );
                    var new_var_form = $( this ).find("#variable-dl-form");

                    new_var_form.find("input").val("");
                    new_var_form.find(".error").remove();   
                }
            });

            
            /* Add a new variable to the form, passing if its an isInputVar */
            function addVariableDialog(isInputVar){
                var dialog = $( "#dialog-modal" );
                var new_var_form = $("#variable-dl-form");

                var title = "Create New KIND Variable"
                if(isInputVar){
                    title = title.replace(/KIND/g, "Input");
                    //sets the val of the kind find  to be the correct one.
                    //based on xfuzzy definition
                    new_var_form.find("[name='kind']").val(@models.Variable.INPUT);
                }
                else{
                    title = title.replace(/KIND/g, "Output");         
                    //sets the val of the kind find  to be the correct one.
                    //based on xfuzzy definition          
                    new_var_form.find("[name='kind']").val(@models.Variable.OUTPUT); 
                }
                $('.ui-dialog-title').html(title);  

                dialog.dialog( "open" );    
            }

            /* Post the new variable */
            function postNewVar(callback){
                var new_var_form = $("#variable-dl-form");
                var post_url = '/ajax/ajax_add_variable_rb/ID_SYS/ID_RB';                
                    post_url = post_url.replace(/ID_SYS/g, "@fuzzySystem.id");     
                    post_url = post_url.replace(/ID_RB/g, "@rb.id");     

                $.post(post_url,
                    new_var_form.serialize(),
                    function(data) {
                        callback(data);
                    },"json")
                    .error(function(xhr, textStatus, errorThrown) {
                        var errors = JSON.parse(xhr.responseText);

                        //for each field in the errrors
                        $.each(errors, function(key, value) { 
                           var field = new_var_form.find("[name='" + key + "']");

                            //add each error to the given field
                            $.each(value, function(index, val){
                               field.parent().append("<span class='error'>"+val+"</span></br>");

                            });
                        });

                        console.log(errors); 
                    });
            }

            //change the add buttons to add new vars
            $('#new_ivar').click(function(){
                event.preventDefault();
                console.log("new_ivar");
                addVariableDialog(true);
            });
            $('#new_ovar').click(function(){
                event.preventDefault();
                console.log("new_ovar");
                addVariableDialog(false);
            });


        });
                
    </script>
    
}
        